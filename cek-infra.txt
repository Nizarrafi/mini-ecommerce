AWSTemplateFormatVersion: '2010-09-09'
Description: 'Advanced 3-Tier Architecture: Public Nginx Proxy, Private App Server, Private RDS'

Parameters:
  DBPassword:
    Type: String
    Description: 'Password for RDS Database'
    NoEcho: true
    MinLength: 8

  JWTSecretParam:
    Type: String
    Description: 'Input your JWT Secret here'
    NoEcho: true
    MinLength: 8

  KeyName:
    Type: AWS::EC2::KeyPair::KeyName
    Description: 'Name of an existing EC2 KeyPair for SSH access'

Resources:
  # ===========================
  # VPC & NETWORKING
  # ===========================
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.0.0.0/16
      EnableDnsSupport: true
      EnableDnsHostnames: true
      Tags:
        - Key: Name
          Value: MeCommerce-VPC

  InternetGateway:
    Type: AWS::EC2::InternetGateway

  VPCGatewayAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref VPC
      InternetGatewayId: !Ref InternetGateway

  # 1 Public Subnet (for App Server)
  PublicSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.1.0/24
      AvailabilityZone: !Select [0, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: MeCommerce-PublicSubnet

  # 1 Private Subnet (for RDS) - Primary
  PrivateSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.2.0/24
      AvailabilityZone: !Select [0, !GetAZs '']
      Tags:
        - Key: Name
          Value: MeCommerce-PrivateSubnet

  # 1 Private Subnet (for RDS) - Secondary (Required for RDS Multi-AZ/Subnet Group)
  PrivateSubnetAZ2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.3.0/24
      AvailabilityZone: !Select [1, !GetAZs '']
      Tags:
        - Key: Name
          Value: MeCommerce-PrivateSubnet-AZ2

  # Routing
  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: MeCommerce-PublicRouteTable

  PublicRoute:
    Type: AWS::EC2::Route
    DependsOn: VPCGatewayAttachment
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway

  PubSubRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet
      RouteTableId: !Ref PublicRouteTable

  # Private Route Table (No Internet Access routes needed for RDS-only subnet)
  PrivateRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: MeCommerce-PrivateRouteTable

  PrivSubRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet
      RouteTableId: !Ref PrivateRouteTable

  PrivSubAZ2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnetAZ2
      RouteTableId: !Ref PrivateRouteTable

  # ===========================
  # SECURITY GROUPS
  # ===========================
  AppSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Allow Web and SSH
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 3000
          ToPort: 3000
          CidrIp: 0.0.0.0/0

  RDSSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Allow Postgres from App ONLY
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 5432
          ToPort: 5432
          SourceSecurityGroupId: !Ref AppSecurityGroup

  # ===========================
  # DATABASE (RDS)
  # ===========================
  DBSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupDescription: RDS Subnet Group
      SubnetIds:
        - !Ref PrivateSubnet
        - !Ref PrivateSubnetAZ2

  DBInstance:
    Type: AWS::RDS::DBInstance
    Properties:
      DBName: miniecommerce
      AllocatedStorage: 20
      DBInstanceClass: db.t3.micro # Free Tier
      Engine: postgres
      MasterUsername: postgres
      MasterUserPassword: !Ref DBPassword
      DBSubnetGroupName: !Ref DBSubnetGroup
      VPCSecurityGroups:
        - !Ref RDSSecurityGroup
      MultiAZ: false
      PubliclyAccessible: false
      DeleteAutomatedBackups: true
      BackupRetentionPeriod: 0

  # ===========================
  # STORAGE (S3) & IAM
  # ===========================
  S3Bucket:
    Type: AWS::S3::Bucket
    Properties:
      OwnershipControls:
        Rules:
          - ObjectOwnership: BucketOwnerEnforced
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        IgnorePublicAcls: true
        BlockPublicPolicy: false
        RestrictPublicBuckets: false

  S3BucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref S3Bucket
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal: "*"
            Action: "s3:GetObject"
            Resource: !Join ['', ['arn:aws:s3:::', !Ref S3Bucket, '/*']]

  EC2Role:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal: { Service: ec2.amazonaws.com }
            Action: sts:AssumeRole
      Policies:
        - PolicyName: S3Access
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action: ['s3:PutObject', 's3:GetObject', 's3:DeleteObject']
                Resource: !Join ['', ['arn:aws:s3:::', !Ref S3Bucket, '/*']]

  EC2InstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties: { Roles: [!Ref EC2Role] }

  # ===========================
  # EC2 INSTANCE (Unified App & Proxy)
  # ===========================
  AppServer:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType: t3.micro
      ImageId: ami-0d5f3e23c61fbb3e8 # Amazon Linux 2023
      KeyName: !Ref KeyName
      SubnetId: !Ref PublicSubnet
      SecurityGroupIds: [!Ref AppSecurityGroup]
      IamInstanceProfile: !Ref EC2InstanceProfile
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          # 1. Install Dependencies
          dnf update -y
          dnf install -y nodejs git nginx openssl
          npm install pm2 -g

          # 2. Setup Application
          cd /home/ec2-user
          # Clone sebagai root tidak apa-apa, nanti kita chown
          git clone https://github.com/Nizarrafi/mini-ecommerce.git app
          cd app
          npm install

          # 3. Configure Environment Variables (Pastikan di folder /app)
          echo "DB_HOST=${DBInstance.Endpoint.Address}" > .env
          echo "DB_USER=postgres" >> .env
          echo "DB_PASS=${DBPassword}" >> .env
          echo "DB_NAME=miniecommerce" >> .env
          echo "JWT_SECRET=${JWTSecretParam}" >> .env
          echo "AWS_BUCKET_NAME=${S3Bucket}" >> .env
          echo "AWS_REGION=${AWS::Region}" >> .env

          # 4. Fix Permissions & Start App
          cd /home/ec2-user
          chown -R ec2-user:ec2-user app
          cd app
          # Jalankan PM2 sebagai user ec2-user agar aman
          sudo -u ec2-user pm2 start server.js --name app
          sudo -u ec2-user pm2 save
          env PATH=$PATH:/usr/bin /usr/local/lib/node_modules/pm2/bin/pm2 startup systemd -u ec2-user --hp /home/ec2-user
          systemctl start pm2-ec2-user

          # 5. Setup Nginx (Edit Langsung File Utama)
          mkdir -p /etc/nginx/ssl
          openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
            -keyout /etc/nginx/ssl/server.key \
            -out /etc/nginx/ssl/server.crt \
            -subj "/CN=localhost"
          
          # Timpa total file nginx.conf
          cat <<EOF > /etc/nginx/nginx.conf
          user nginx;
          worker_processes auto;
          events { worker_connections 1024; }

          http {
              include       /etc/nginx/mime.types;
              default_type  application/octet-stream;

              server {
                  listen 80;
                  server_name _;
                  return 301 https://\$host\$request_uri;
              }

              server {
                  listen 443 ssl;
                  server_name _;

                  ssl_certificate /etc/nginx/ssl/server.crt;
                  ssl_certificate_key /etc/nginx/ssl/server.key;

                  location / {
                      proxy_pass http://localhost:3000;
                      proxy_http_version 1.1;
                      proxy_set_header Upgrade \$http_upgrade;
                      proxy_set_header Connection 'upgrade';
                      proxy_set_header Host \$host;
                      proxy_cache_bypass \$http_upgrade;
                  }
              }
          }
          EOF
          
          # Restart Nginx
          systemctl restart nginx
          systemctl enable nginx          

Outputs:
  WebsiteURL:
    Description: Access your website here
    Value: !Sub 'https://${AppServer.PublicIp}'
  AppServerPublicIP:
    Value: !GetAtt AppServer.PublicIp
  DBEndpoint:
    Value: !GetAtt DBInstance.Endpoint.Address
